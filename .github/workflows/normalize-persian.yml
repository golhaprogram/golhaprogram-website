name: Normalize Persian Text

on:
  pull_request:
    paths:
      - '**/*.md'
      - '**/*.markdown'

jobs:
  normalize-persian:
    runs-on: ubuntu-latest
    # Only run if PR is from same repository (not forks)
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ github.head_ref }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Get changed files
      id: changed-files
      run: |
        # Get only the markdown files that were actually changed in this PR
        git fetch origin ${{ github.base_ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(md|markdown)$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No markdown files changed in this PR"
          echo "changed_files=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Changed markdown files:"
        echo "$CHANGED_FILES"
        
        # Convert to space-separated list for the next step
        CHANGED_FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')
        echo "changed_files=$CHANGED_FILES_LIST" >> $GITHUB_OUTPUT
    
    - name: Normalize Persian Text
      id: normalize
      if: steps.changed-files.outputs.changed_files != ''
      run: |
        CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No files to process"
          exit 0
        fi
        
        # Create the normalizer script
        cat > normalize.js << 'EOF'
        const fs = require('fs');
        
        function normalizePersianText(text) {
            return text
                // Most common issues
                .replace(/Ùƒ/g, 'Ú©')   // Arabic kaf to Persian kaf
                .replace(/ÙŠ/g, 'ÛŒ')   // Arabic yeh to Persian yeh
                
                // Other Arabic letters commonly mixed up
                .replace(/Ø¤/g, 'Ùˆ')   // Arabic waw with hamza to Persian waw
                .replace(/Ø¥/g, 'Ø§')   // Arabic alef with hamza below to Persian alef
                .replace(/Ø£/g, 'Ø§')   // Arabic alef with hamza above to Persian alef
                .replace(/Ø¢/g, 'Ø¢')   // Ensure consistent alef with madda (this is actually correct)
                .replace(/Ø©/g, 'Ù‡')   // Arabic teh marbuta to Persian heh
                
                // Numbers - Arabic-Indic to Persian
                .replace(/Ù /g, 'Û°')   // 0
                .replace(/Ù¡/g, 'Û±')   // 1
                .replace(/Ù¢/g, 'Û²')   // 2
                .replace(/Ù£/g, 'Û³')   // 3
                .replace(/Ù¤/g, 'Û´')   // 4
                .replace(/Ù¥/g, 'Ûµ')   // 5
                .replace(/Ù¦/g, 'Û¶')   // 6
                .replace(/Ù§/g, 'Û·')   // 7
                .replace(/Ù¨/g, 'Û¸')   // 8
                .replace(/Ù©/g, 'Û¹')   // 9
                
                // Less common but still seen
                .replace(/Ø¡/g, 'Ù”')   // Arabic hamza to Persian hamza
                .replace(/Ø¦/g, 'Ø¦')   // Ensure Persian yeh with hamza (this is correct)
                .replace(/Ø¤/g, 'Ø¤');  // Persian waw with hamza (keep as is)
        }
        
        function processFile(filePath) {
            try {
                if (!fs.existsSync(filePath)) {
                    console.log('âš ï¸  File not found:', filePath);
                    return false;
                }
                
                const content = fs.readFileSync(filePath, 'utf8');
                const normalized = normalizePersianText(content);
                
                if (content !== normalized) {
                    fs.writeFileSync(filePath, normalized, 'utf8');
                    console.log('âœ… Normalized:', filePath);
                    return true;
                } else {
                    console.log('âœ¨ Already normalized:', filePath);
                    return false;
                }
            } catch (error) {
                console.error('âŒ Error processing', filePath, ':', error.message);
                return false;
            }
        }
        
        // Process only the files passed as arguments
        const files = process.argv.slice(2).filter(f => f.trim().length > 0);
        
        if (files.length === 0) {
            console.log('No files to process');
            process.exit(0);
        }
        
        console.log(`Processing ${files.length} changed markdown files:`);
        files.forEach(f => console.log(`  - ${f}`));
        
        let changedFiles = [];
        files.forEach(file => {
            if (processFile(file.trim())) {
                changedFiles.push(file.trim());
            }
        });
        
        if (changedFiles.length > 0) {
            console.log(`\nðŸŽ‰ Normalized ${changedFiles.length} files:`);
            changedFiles.forEach(file => console.log(`  - ${file}`));
            process.exit(1); // Signal that changes were made
        } else {
            console.log('\nâœ¨ All files already normalized - no changes needed');
            process.exit(0);
        }
        EOF
        
        # Run the script with only the changed files
        node normalize.js $CHANGED_FILES
    
    - name: Commit and push changes
      if: failure() # Only runs if normalization script found changes (exit 1)
      run: |
        # Clean up the temporary script
        rm -f normalize.js
        
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add -A
        
        if git diff --cached --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        git commit -m "ðŸ”„ Auto-normalize Persian text
        
        Converted Arabic letters to Persian equivalents in changed files:
        - Ùƒ â†’ Ú© (kaf)
        - ÙŠ â†’ ÛŒ (yeh)
        - Ø¤ â†’ Ùˆ (waw)
        - Ø¥/Ø£ â†’ Ø§ (alef)
        - Ø© â†’ Ù‡ (heh)
        - Arabic-Indic numerals â†’ Persian numerals
        
        Only processed files modified in this PR."
        
        git push origin ${{ github.head_ref }}
    
    - name: Cleanup
      if: always()
      run: |
        # Always clean up the temporary script
        rm -f normalize.js